stages:
  - build
  - test
  - deploy
  - mirror

variables:
  NODE_VERSION: "18"
  GIT_DEPTH: 0  # Full clone for proper mirroring

before_script:
  - echo "Starting pipeline for oscillo project"

build:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - main
    - develop
  allow_failure: true  # Don't block pipeline if build fails

test:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm run test
  only:
    - main
    - develop
  allow_failure: true  # Don't block pipeline if tests fail

deploy:
  stage: deploy
  script:
    - echo "Deploy stage ready for configuration"
  only:
    - main
  when: on_success  # Only run if previous stages succeed

# GitHub Mirror Job - Runs regardless of other stages
mirror-to-github:
  stage: mirror
  image: alpine/git:latest
  before_script:
    - apk add --no-cache git
  script:
    - git config --global user.email "gitlab@gitlabmaster.local"
    - git config --global user.name "GitLab CI"
    - echo "Setting up GitHub remote..."
    - git remote add github https://${GITHUB_TOKEN}@github.com/zachyzissou/interactive-music-3d.git || git remote set-url github https://${GITHUB_TOKEN}@github.com/zachyzissou/interactive-music-3d.git
    - echo "Fetching latest changes..."
    - git fetch origin
    - git checkout ${CI_COMMIT_REF_NAME}
    - echo "Pushing to GitHub..."
    - git push github ${CI_COMMIT_REF_NAME}:main --force
    - echo "âœ“ Successfully mirrored to GitHub"
  only:
    - main
    - master
  tags:
    - docker
    - unraid
  when: always  # Run regardless of previous stage results
  allow_failure: false
