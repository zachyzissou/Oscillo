stages:
  - validate
  - mirror

node-version-guard:
  stage: validate
  image: node:20.17.0
  script:
    - node --version
    - npm --version
    - node scripts/check-node.js
  only:
    - main

mirror-to-github:
  stage: mirror
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl jq
  script:
    - git config --global user.email "gitlab@gitlabmaster.local"
    - git config --global user.name "GitLab CI"
    
    # Check if repo exists, create if not
    - |
      echo "Checking if GitHub repo exists..."
      REPO_CHECK=$(curl -s -o /dev/null -w "%{http_code}"         -H "Authorization: token ${GITHUB_TOKEN}"         https://api.github.com/repos/zachyzissou/interactive-music-3d)
      
      if [ "$REPO_CHECK" = "404" ]; then
        echo "Repository doesn't exist. Creating it..."
        curl -X POST -H "Authorization: token ${GITHUB_TOKEN}"           -H "Content-Type: application/json"           -d '{"name":"interactive-music-3d","description":"Oscillo - Interactive Music Visualizer","private":false}'           https://api.github.com/user/repos
        echo "Repository created!"
        sleep 2
      else
        echo "Repository exists (HTTP $REPO_CHECK)"
      fi
    
    # Now push to GitHub
    - echo "Pushing to GitHub..."
    - git remote add github https://${GITHUB_TOKEN}@github.com/zachyzissou/interactive-music-3d.git || true
    - git push github HEAD:main --force
    - echo "âœ“ Successfully mirrored to GitHub!"
  only:
    - main
