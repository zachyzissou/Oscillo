stages:
  - verify
  - e2e

.default:
  image: node:20-bullseye
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/

lint_and_types:
  stage: verify
  before_script:
    - npm ci
  script:
    - mkdir -p reports/lint
    - npm run lint:check
    - npm run type-check
  artifacts:
    when: always
    paths:
      - reports/lint/
    expire_in: 7 days

unit_tests:
  stage: verify
  before_script:
    - npm ci
  script:
    - npm run test:unit -- --coverage --runInBand
  artifacts:
    when: always
    paths:
      - coverage/
    reports:\n      coverage_report:\n        coverage_format: cobertura\n        path: coverage/cobertura-coverage.xml
    expire_in: 7 days
  needs:
    - lint_and_types

playwright_smoke:
  stage: e2e
  image: mcr.microsoft.com/playwright:v1.45.0-focal
  before_script:
    - npm ci
  script:
    - npm run test:smoke -- --reporter=line
  artifacts:
    when: on_failure
    paths:
      - playwright-report/
    expire_in: 7 days
  needs:
    - unit_tests

playwright_performance:
  stage: e2e
  image: mcr.microsoft.com/playwright:v1.45.0-focal
  before_script:
    - npm ci
  script:
    - npm run test:performance -- --reporter=line
  artifacts:
    when: always
    paths:
      - test-results/performance/
    expire_in: 7 days
  needs:
    - unit_tests

record_metrics:
  stage: e2e
  script:
    - echo "Attach metrics via npm run openproject:enrich or custom script"
  when: manual
  needs:
    - unit_tests

