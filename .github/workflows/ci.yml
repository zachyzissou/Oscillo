name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  # Quick checks for all PRs and main branch - under 10 minutes
  quick-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npx tsc --noEmit
      - run: npm run lint:check
      - run: npm test -- --run
      - run: npm run build
      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: .next
          include-hidden-files: true
          if-no-files-found: error
          retention-days: 1
      - name: Install Playwright browser and system dependencies
        run: npx playwright install --with-deps chromium
      - name: Run Playwright smoke tests
        run: npm run test:smoke
        env:
          CI: true

  security-audit:
    runs-on: ubuntu-latest
    env:
      SECURITY_AUDIT_LEVEL: ${{ vars.SECURITY_AUDIT_LEVEL }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - name: Run security audit gate
        run: |
          level="${SECURITY_AUDIT_LEVEL:-high}"
          echo "Running npm audit with threshold: ${level}"
          npm audit --audit-level "${level}" --json > security-audit-report.json
      - name: Summarize security audit report
        if: always()
        run: |
          if [ ! -f security-audit-report.json ]; then
            echo "security-audit-report.json was not generated."
            exit 1
          fi
          node -e "const fs=require('fs');const p='security-audit-report.json';const r=JSON.parse(fs.readFileSync(p,'utf8'));const v=r.metadata?.vulnerabilities||{};console.log('vulnerabilities:', JSON.stringify(v));"
      - name: Upload security audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: security-audit-report.json
          retention-days: 14

  # Full test suite - only runs on staging branch
  full-tests:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging'
    needs: quick-checks
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: .next
          if-no-files-found: error
      - name: List downloaded build
        run: ls -al .next | head
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
      - name: Install system Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
        continue-on-error: true
      - name: Install Playwright dependencies
        run: npx playwright install-deps
        continue-on-error: true
      - name: Run full E2E test suite
        run: npm run test:e2e
        env:
          CI: true
      - name: Run visual regression tests
        run: npm run test:visual
        env:
          CI: true
          RUN_VISUAL_REGRESSION: '1'
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
      - name: Upload test videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-videos
          path: test-results/
          retention-days: 30

  visual-regression:
    runs-on: ubuntu-latest
    needs: quick-checks
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - name: Install Playwright browsers and dependencies
        run: npx playwright install --with-deps chromium
      - name: Run visual regression suite (chromium)
        run: npx playwright test tests/e2e/visual-regression.spec.ts --project=chromium
        env:
          CI: true
          RUN_VISUAL_REGRESSION: '1'
      - name: Upload visual report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-playwright-report
          path: playwright-report/
          retention-days: 14
      - name: Upload visual failures
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-test-results
          path: test-results/
          retention-days: 14

  baseline-ci:
    runs-on: ubuntu-latest
    needs: [quick-checks, visual-regression, security-audit, full-tests]
    if: always()
    steps:
      - name: Enforce baseline CI signal
        run: |
          quick="${{ needs.quick-checks.result }}"
          visual="${{ needs.visual-regression.result }}"
          security="${{ needs.security-audit.result }}"
          full="${{ needs.full-tests.result }}"

          echo "quick-checks: ${quick}"
          echo "visual-regression: ${visual}"
          echo "security-audit: ${security}"
          echo "full-tests: ${full}"

          if [ "${quick}" != "success" ]; then
            echo "quick-checks must pass."
            exit 1
          fi

          if [ "${visual}" != "success" ]; then
            echo "visual-regression must pass."
            exit 1
          fi

          if [ "${security}" != "success" ]; then
            echo "security-audit must pass."
            exit 1
          fi

          if [ "${full}" = "failure" ] || [ "${full}" = "cancelled" ]; then
            echo "full-tests cannot fail when scheduled."
            exit 1
          fi

  ci:
    name: CI
    runs-on: ubuntu-latest
    needs: baseline-ci
    if: always()
    steps:
      - name: Publish legacy CI gate
        run: |
          baseline="${{ needs.baseline-ci.result }}"
          echo "baseline-ci: ${baseline}"

          if [ "${baseline}" != "success" ]; then
            echo "baseline-ci must pass before CI can pass."
            exit 1
          fi
